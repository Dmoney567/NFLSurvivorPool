<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Survivor Pool</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .admin-controls {
      margin-bottom: 20px;
    }
    .winner-select {
      padding: 4px;
      margin-right: 8px;
    }
    .update-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .update-btn:hover {
      background-color: #218838;
    }
    .week-selector {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Admin Panel</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="picks.html">Picks</a>
      <a href="standings.html">Standings</a>
      <a href="admin.html" class="active">Admin</a>
      <a href="index.html">Logout</a>
    </nav>
  </header>

  <main>
    <h2>Manage Matchups</h2>
    <div class="week-selector">
      <label for="weekSelect"><strong>Current Week:</strong></label>
      <select id="weekSelect"></select>
    </div>

    <p>Add, remove, and update game results below.</p>

    <div class="admin-controls">
      <select id="homeTeamSelect">
        <option value="">Select Home Team</option>
      </select>
      <select id="awayTeamSelect">
        <option value="">Select Away Team</option>
      </select>
      <input type="number" id="spreadInput" placeholder="Spread (e.g. 3.5)" step="0.5" />
      <select id="favoredSelect">
        <option value="home">Home Favored</option>
        <option value="away">Away Favored</option>
      </select>
      <button id="addMatchupBtn">Add Matchup</button>
      <button id="clearAllBtn" class="danger-btn">Clear All</button>
    </div>

    <table id="adminGamesTable">
      <thead>
        <tr>
          <th>Home Team</th>
          <th>Away Team</th>
          <th>Spread</th>
          <th>Winner</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <p>&copy; 2025 NFL Survivor Pool</p>
  </footer>

  <script>
    const teams = [
      "49ers","Bears","Bengals","Bills","Broncos","Browns","Buccaneers","Cardinals",
      "Chargers","Chiefs","Colts","Commanders","Cowboys","Dolphins","Eagles","Falcons",
      "Giants","Jaguars","Jets","Lions","Packers","Panthers","Patriots","Raiders",
      "Rams","Ravens","Saints","Seahawks","Steelers","Texans","Titans","Vikings"
    ];

    const homeSelect = document.getElementById("homeTeamSelect");
    const awaySelect = document.getElementById("awayTeamSelect");
    const spreadInput = document.getElementById("spreadInput");
    const favoredSelect = document.getElementById("favoredSelect");
    const addBtn = document.getElementById("addMatchupBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const tableBody = document.querySelector("#adminGamesTable tbody");
    const weekSelect = document.getElementById("weekSelect");

    // Load and setup week options
    for (let i = 1; i <= 18; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `Week ${i}`;
      weekSelect.appendChild(opt);
    }

    let currentWeek = parseInt(localStorage.getItem("currentWeek")) || 1;
    weekSelect.value = currentWeek;
    weekSelect.addEventListener("change", () => {
      currentWeek = parseInt(weekSelect.value);
      localStorage.setItem("currentWeek", currentWeek);
      renderMatchups();
    });

    let matchups = JSON.parse(localStorage.getItem("matchups")) || [];

    // Populate dropdowns
    teams.forEach(t => {
      const opt1 = document.createElement("option");
      opt1.value = opt1.textContent = t;
      homeSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = opt2.textContent = t;
      awaySelect.appendChild(opt2);
    });

    // Render matchups
    function renderMatchups() {
      tableBody.innerHTML = "";
      const currentWeekMatchups = matchups.filter(m => m.week === currentWeek);
      if (currentWeekMatchups.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5">No matchups for Week ${currentWeek}.</td></tr>`;
        return;
      }

      currentWeekMatchups.forEach((m, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${m.home}</td>
          <td>${m.away}</td>
          <td>${m.spread}</td>
          <td>
            <select class="winner-select" id="winnerSelect${i}">
              <option value="">Select Winner</option>
              <option value="${m.home}">${m.home}</option>
              <option value="${m.away}">${m.away}</option>
            </select>
            <button class="update-btn" onclick="setWinner(${i})">Set Winner</button>
          </td>
          <td><button class="danger-btn" onclick="removeMatchup(${i})">Remove</button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // Add matchup
    addBtn.addEventListener("click", () => {
      const home = homeSelect.value;
      const away = awaySelect.value;
      const spreadVal = parseFloat(spreadInput.value);
      const favored = favoredSelect.value;

      if (!home || !away) return alert("Please select both teams.");
      if (home === away) return alert("Teams must be different.");
      if (isNaN(spreadVal)) return alert("Please enter a valid spread number.");

      const spread = favored === "home" ? -Math.abs(spreadVal) : Math.abs(spreadVal);

      matchups.push({ week: currentWeek, home, away, spread, winner: "" });
      localStorage.setItem("matchups", JSON.stringify(matchups));

      homeSelect.value = "";
      awaySelect.value = "";
      spreadInput.value = "";
      favoredSelect.value = "home";

      renderMatchups();
    });

    // Remove matchup
    function removeMatchup(index) {
      matchups.splice(index, 1);
      localStorage.setItem("matchups", JSON.stringify(matchups));
      renderMatchups();
    }

    // Clear all
    clearAllBtn.addEventListener("click", () => {
      if (confirm("Clear all matchups?")) {
        matchups = [];
        localStorage.removeItem("matchups");
        renderMatchups();
      }
    });

    // ===============================
    // Set Winner and Update Standings
    // ===============================
    function setWinner(index) {
      const weekMatchups = matchups.filter(m => m.week === currentWeek);
      const winner = document.getElementById(`winnerSelect${index}`).value;
      if (!winner) return alert("Please select a winner.");

      weekMatchups[index].winner = winner;
      const globalIndex = matchups.findIndex(m => m.week === currentWeek && m.home === weekMatchups[index].home && m.away === weekMatchups[index].away);
      matchups[globalIndex] = weekMatchups[index];
      localStorage.setItem("matchups", JSON.stringify(matchups));

      let players = JSON.parse(localStorage.getItem("players")) || [];

      players.forEach(player => {
        player.picks.forEach(pick => {
          if (pick.week === currentWeek && pick.result === "pending") {
            const winnerAbbr = winner.substring(0, 3).toUpperCase();
            const pickAbbr = pick.team.substring(0, 3).toUpperCase();
            if (pickAbbr === winnerAbbr) {
              pick.result = "win";
            } else {
              pick.result = "loss";
              player.alive = false;
            }
          }
        });

        // Lock future weeks if eliminated
        if (!player.alive) {
          player.picks.forEach(p => {
            if (p.week > currentWeek && p.result === "pending") {
              p.result = "locked";
            }
          });
        }
      });

      localStorage.setItem("players", JSON.stringify(players));
      alert(`Winner set as ${winner} for Week ${currentWeek}. Standings updated.`);
    }

    renderMatchups();
  </script>
</body>
</html>
